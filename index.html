<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>The HTML5 Herald</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="Boone Putney" >
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" />
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="css/styles.css?v=1.0">

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<style type="text/css">
.color-block{display:inline-block;}
.picker-row{text-align:center;width:100%;overflow:hidden;}
</style>

<script type="text/javascript">
(function ( $ ) {

	$.fn.defaults = {
		"colorModel":"hsv",
		"size":5, //length of picker
		"pickerWidth":200, //width of picker
		"container":"none", //"none", "dialog"
   };
   
	$.fn.hexColorPicker = function(options) {
		settings = $.extend( {}, $.fn.defaults, options );
		settings.blockWidth = Math.floor(settings.pickerWidth/(settings.size*2-1));
		settings.maxBlocks=settings.size*2-1
		$(this).after(formatPicker());
		$('.hex-color-picker-wrapper .color-block').css({
			"width":settings.blockWidth.toString()+"px",
			"height":settings.blockWidth.toString()+"px",	
		});
		$('.hex-color-picker-wrapper .color-picker-container').css({
			"width":settings.pickerWidth.toString()+"px",
		});
		$('.hex-color-picker-wrapper .picker-row').css({
			"height":settings.blockWidth.toString()+"px",
		});
		
		$('.color-picker-container .color-block').click(function(){
			$(".picker-sidebar").html(createSidebar($(this).css("background-color")));
			$('.picker-sidebar .color-block').css({
				"width":settings.blockWidth.toString()+"px",
				"height":settings.blockWidth.toString()+"px",	
			});
		});
	};
   
	function hexStringTwoDigits(hexString){
		return ("00"+hexString).slice(-2);
	}   
   
	function numericRGBtoString(r,g,b){
		return "#"+hexStringTwoDigits(r.toString(16))+hexStringTwoDigits(g.toString(16))+hexStringTwoDigits(b.toString(16));	
	}   
   
	function colorizeBlock(normRadius, angle, valueLightness){
		var angle, hue, lightness, saturation,r,g,b;
		if(settings.colorModel === "hsv"){
			hue=angle%360;//swap 360 with 0;
			saturation=normRadius;
			chroma=valueLightness*saturation;
			huePrime=hue/60;
			X=chroma*(1-Math.abs(huePrime%2-1));
			matchValue=valueLightness-chroma;
			[r,g,b] = [0,0,0]; //default if undefined
			switch(Math.floor(huePrime)){
				case 0:
					[r,g,b]=[chroma,X,0];
					break;
				case 1:
					[r,g,b]=[X,chroma,0];
					break;
				case 2:
					[r,g,b]=[0,chroma,X];
					break;
				case 3:
					[r,g,b]=[0,X,chroma];
					break;
				case 4:
					[r,g,b]=[X,0,chroma];
					break;
				case 5:
					[r,g,b]=[chroma,0,X];
					break;	
			}
			[r,g,b]=[Math.floor((r+matchValue)*255),Math.floor((g+matchValue)*255),Math.floor((b+matchValue)*255)];
			return numericRGBtoString(r,g,b);
		}else{
			hue=angle;
			lightness=0.5;
			saturation=angle;		
		}
	
	}   
   
	function createSidebar(rgbColor){
		var huePrime;
		[rgbColor,r,g,b] = rgbColor.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
		[r,g,b]=[r/255,g/255,b/255]
		maxComponent = Math.max.apply(Math,[r,g,b]);
		minComponent = Math.min.apply(Math,[r,g,b]);
		chroma=maxComponent-minComponent;
		if(chroma==0){
			huePrime=0;
		}else if(maxComponent==r){
			huePrime=((g-b)/chroma+6)%6;		
		}else if(maxComponent==g){
			huePrime=((b-r)/chroma)+2;		
		}else if(maxComponent==b){
			huePrime=((r-g)/chroma)+4;		
		}
		hue=huePrime*60;
		if(settings.colorModel=="hsv"){
			saturation=chroma;		
		}
		
		console.log(rgbColor+minComponent.toString());
		output='';
		valueLightness=0;
		for(var row=0;row<settings.maxBlocks;row++){
			console.log([saturation,hue,valueLightness]);
			output+="<div class='color-block' style='background-color:"+colorizeBlock(saturation,hue,valueLightness)+"'></div>";			
			valueLightness+=1/settings.maxBlocks;
		}
		return output;
	}   
   
	function formatPicker(){
		var radius,angle,x,y,valueLightness;
		var output="<div class='hex-color-picker-wrapper'>";
		var centerBlock=Math.floor(settings.maxBlocks/2);
		var maxRadius=Math.sqrt(5/4)*centerBlock;
		output+="<div class='color-picker-container'>";
		for(var row=0;row<settings.maxBlocks;row++){
			var blocksCount = settings.size+row;
			if(row>=settings.size){
				blocksCount = settings.size*2-(row-settings.size+2)	
			}	
			output+="<div class='picker-row'>"
			for(var block=0;block<blocksCount;block++){
				y=centerBlock-row;
				x=-centerBlock+(block+(settings.maxBlocks-blocksCount)/2);
				radius=Math.sqrt(Math.pow(x,2)+Math.pow(y,2));
				normRadius=radius/maxRadius;
				angle=Math.atan(y/x)*180/Math.PI+90;
				if(x>=0){
					angle+=180;//compensate for right 2 quadrants			
				}
				if(settings.colorModel=="hsv"){
					valueLightness=1;
				}
				output+="<div class='color-block' style='background-color:"+colorizeBlock(normRadius,angle,valueLightness)+"'></div>";			
			}
			output+="</div>";
		}
		output+="</div>";
		output+='<div class="picker-sidebar"></div>';
		output+="</div>";//end of hex-color-picker-wrapper
		return output;
	}   
   
   var settings = {};
 
}( jQuery ));

jQuery(function(){
	jQuery(".color-picker").hexColorPicker();
});
</script>
<body>
  <form>
	<input type="text" class="color-picker"/>
	<input type="text" class="color-picker"/>
	<input type="text" id="color-picker2"/>
  </form>
</body>
</html>